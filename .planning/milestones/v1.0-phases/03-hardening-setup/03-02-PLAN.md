---
phase: 03-hardening-setup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/setup.js
  - .env.example
  - hooks/claude-code-hook.sh
  - package.json
autonomous: true

must_haves:
  truths:
    - "User can run one command (npm run setup) and get a working .env with generated auth token"
    - "Setup script does NOT overwrite existing .env file"
    - "Setup script installs npm dependencies automatically"
    - "Setup script prints clear next-steps instructions including Twilio credential configuration"
    - "User has a ready-to-copy hook script and instructions for Claude Code settings.json configuration"
  artifacts:
    - path: "scripts/setup.js"
      provides: "One-command setup automation"
      contains: "randomBytes"
    - path: "hooks/claude-code-hook.sh"
      provides: "Claude Code notification hook script"
      contains: "curl"
    - path: ".env.example"
      provides: "Template for environment variables"
      contains: "AUTH_TOKEN"
    - path: "package.json"
      provides: "setup script entry point"
      contains: "setup"
  key_links:
    - from: "package.json"
      to: "scripts/setup.js"
      via: "npm run setup script"
      pattern: "\"setup\".*scripts/setup\\.js"
    - from: "scripts/setup.js"
      to: ".env.example"
      via: "reads template to generate .env"
      pattern: "\\.env\\.example"
    - from: "hooks/claude-code-hook.sh"
      to: "http://localhost:3000/api/notify"
      via: "curl POST to notify endpoint"
      pattern: "localhost:3000/api/notify"
---

<objective>
Create a one-command setup script and Claude Code hook configuration template (OPS-02, OPS-03).

Purpose: New users should be able to clone the repo and run a single command to get started. The setup script generates a cryptographically secure auth token, creates a .env file from the template, installs dependencies, and prints clear next-step instructions. The hook template provides a ready-to-use script for Claude Code's Notification hook.

Output: Working `npm run setup` command and a hook script users can reference in their Claude Code settings.
</objective>

<execution_context>
@/Users/tylermeans/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tylermeans/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-hardening-setup/03-RESEARCH.md
@package.json
@.env.example
@src/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create setup script and update package.json</name>
  <files>scripts/setup.js, package.json, .env.example</files>
  <action>
    Create `scripts/setup.js` as an ES module script (project uses type=module):

    1. **Shebang + imports:**
       - `#!/usr/bin/env node`
       - Import `randomBytes` from `crypto`
       - Import `writeFileSync`, `existsSync`, `readFileSync` from `fs`
       - Import `execFileSync` from `child_process` (use execFile, never exec -- per project decision)
       - Import `join`, `dirname` from `path`
       - Import `fileURLToPath` from `url`
       - Derive `__dirname` from `import.meta.url` (ES module pattern)
       - Set `PROJECT_ROOT = join(__dirname, '..')`

    2. **generateAuthToken() function:**
       - Use `randomBytes(32).toString('hex')` for 64-char hex token
       - Never use Math.random() (per research don't-hand-roll)

    3. **createEnvFile() function:**
       - Check if `.env` already exists -- if yes, print warning and return null (never overwrite -- pitfall 4)
       - Check if `.env.example` exists -- if no, print error and exit
       - Read `.env.example` template
       - Generate auth token via `generateAuthToken()`
       - Replace `generate_with_openssl_rand_hex_32` placeholder with generated token
       - Write `.env` file
       - Return the generated token

    4. **installDeps() function:**
       - Run `execFileSync('npm', ['install'], { cwd: PROJECT_ROOT, stdio: 'inherit' })`
       - Use execFile with args array (never exec -- project convention)
       - Wrap in try/catch, log warning if fails but don't exit

    5. **printInstructions(authToken) function:**
       Print clear next-steps (strip non-ASCII emojis to keep output clean per project convention, use plain text markers instead):

       ```
       === Claude SMS Connect - Setup Complete ===

       [OK] Auth token generated and saved to .env
       [OK] Dependencies installed

       --- NEXT STEPS ---

       1. Edit .env and add your Twilio credentials:
          - TWILIO_ACCOUNT_SID  (from Twilio Console > Account Info)
          - TWILIO_AUTH_TOKEN   (from Twilio Console > Account Info)
          - TWILIO_PHONE_NUMBER (your Twilio phone number, e.g., +15551234567)
          - USER_PHONE_NUMBER   (your personal phone number, e.g., +15559876543)

       2. Start the server:
          npm run dev

       3. Set up ngrok tunnel (in another terminal):
          ngrok http 3000

       4. Configure Twilio webhook:
          - Go to Twilio Console > Phone Numbers > Active Numbers
          - Set Messaging webhook to: https://YOUR-NGROK-URL/sms/inbound

       5. Configure Claude Code hook:
          - Copy hooks/claude-code-hook.sh to your preferred location
          - Make it executable: chmod +x hooks/claude-code-hook.sh
          - Edit the AUTH_TOKEN value in the script to match your .env
          - Add to Claude Code settings (see instructions in the hook script)

       Your AUTH_TOKEN: <token>
       (Save this -- you will need it for the Claude Code hook configuration)
       ```

    6. **main() function:**
       - Call createEnvFile()
       - Call installDeps()
       - Call printInstructions(authToken)
       - Wrap in try/catch with process.exit(1) on error

    7. **Update package.json:**
       - Add `"setup": "node scripts/setup.js"` to the `scripts` section

    8. **Update .env.example** (minor):
       - Add `TMUX_SESSION` variable with comment explaining it is optional (used for single-project mode)
       - Ensure the AUTH_TOKEN placeholder text matches what setup.js replaces
  </action>
  <verify>
    - `node scripts/setup.js` runs without error when .env does NOT exist (creates .env with token)
    - Running again when .env exists prints warning and does not overwrite
    - `npm run setup` works from package.json
    - Generated .env contains a 64-character hex AUTH_TOKEN
    - `npx tsc --noEmit` still passes (no type breakage)
  </verify>
  <done>
    - setup script generates cryptographically secure auth token
    - setup script creates .env from .env.example template without overwriting existing
    - setup script installs npm dependencies
    - setup script prints complete next-steps instructions
    - npm run setup registered in package.json
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Claude Code hook script and configuration instructions</name>
  <files>hooks/claude-code-hook.sh</files>
  <action>
    Create `hooks/claude-code-hook.sh` -- a shell script that Claude Code executes as a Notification hook.

    1. **Script content:**
       ```bash
       #!/usr/bin/env bash
       # Claude Code Notification Hook - SMS Relay
       #
       # This script is called by Claude Code when it needs user input.
       # It sends a notification to your SMS relay server.
       #
       # SETUP:
       # 1. Copy this file to a permanent location (e.g., ~/.claude/hooks/)
       # 2. Make executable: chmod +x claude-code-hook.sh
       # 3. Edit AUTH_TOKEN below to match your .env file
       # 4. Add to Claude Code settings (~/.claude/settings.json):
       #
       #    {
       #      "hooks": {
       #        "Notification": [
       #          {
       #            "matcher": "",
       #            "hooks": [
       #              {
       #                "type": "command",
       #                "command": "/path/to/claude-code-hook.sh",
       #                "timeout": 5
       #              }
       #            ]
       #          }
       #        ]
       #      }
       #    }
       #
       # ENVIRONMENT VARIABLES (set by Claude Code):
       #   CLAUDE_SESSION_ID - Unique session identifier
       #   CLAUDE_PROJECT_DIR - Project directory path

       AUTH_TOKEN="YOUR_AUTH_TOKEN_HERE"
       SERVER_URL="http://localhost:3000"

       # Derive project info from environment
       PROJECT_DIR="${CLAUDE_PROJECT_DIR:-$(pwd)}"
       PROJECT_NAME="${PROJECT_DIR##*/}"
       SESSION_ID="${CLAUDE_SESSION_ID:-default}"

       # Send notification to relay server
       curl -s -X POST "${SERVER_URL}/api/notify" \
         -H "Authorization: Bearer ${AUTH_TOKEN}" \
         -H "Content-Type: application/json" \
         -d "{
           \"session_id\": \"${SESSION_ID}\",
           \"project_id\": \"${PROJECT_NAME}\",
           \"project_name\": \"${PROJECT_NAME}\",
           \"tmux_session\": \"${SESSION_ID}\"
         }" \
         --max-time 5 \
         > /dev/null 2>&1 || true
       ```

    2. **Key design decisions:**
       - Use `|| true` at end so hook never fails Claude Code (graceful failure)
       - Use `--max-time 5` to match Claude Code's hook timeout
       - Use `-s` (silent) to suppress curl progress
       - Redirect output to /dev/null (Claude Code doesn't need hook output)
       - Derive project_name from directory name (portable, no extra config)
       - Use SCREAMING_SNAKE_CASE for `YOUR_AUTH_TOKEN_HERE` placeholder (pitfall 5 from research)
       - Empty matcher ("") matches all notification types

    3. **Make the file executable:**
       - After creating the file, run: `chmod +x hooks/claude-code-hook.sh`
  </action>
  <verify>
    - File exists at hooks/claude-code-hook.sh
    - File is executable (chmod +x applied)
    - File contains AUTH_TOKEN placeholder in SCREAMING_SNAKE_CASE
    - File contains complete Claude Code settings.json example in header comments
    - `bash -n hooks/claude-code-hook.sh` passes syntax check
    - `grep 'YOUR_AUTH_TOKEN_HERE' hooks/claude-code-hook.sh` finds the placeholder
  </verify>
  <done>
    - Hook script exists with clear setup instructions in comments
    - Script sends POST to /api/notify with project context
    - Script fails gracefully (never blocks Claude Code)
    - Settings.json configuration example included in comments
    - Placeholder token uses obvious SCREAMING_SNAKE_CASE format
  </done>
</task>

</tasks>

<verification>
1. `npm run setup` creates .env with generated token, installs deps, prints instructions
2. Running setup again does NOT overwrite existing .env
3. hooks/claude-code-hook.sh exists, is executable, passes `bash -n` syntax check
4. Hook script includes complete settings.json configuration example
5. `npx tsc --noEmit` passes (no type breakage from any changes)
</verification>

<success_criteria>
- One-command setup: `npm run setup` handles token generation, .env creation, dependency installation, and instruction printing
- Setup is idempotent (safe to run multiple times)
- Hook script is ready to copy and configure with clear instructions
- User has everything needed to go from clone to running in minutes
</success_criteria>

<output>
After completion, create `.planning/phases/03-hardening-setup/03-02-SUMMARY.md`
</output>
