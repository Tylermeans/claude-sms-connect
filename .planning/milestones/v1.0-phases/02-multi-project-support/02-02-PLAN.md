---
phase: 02-multi-project-support
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/routes/notify.ts
  - src/routes/sms.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "User receives numbered SMS prompt when multiple projects need input (e.g., '[1] project-a')"
    - "User can reply with number + response (e.g., '1 Y') and it routes to correct project"
    - "User can text 'ON' to arm SMS alerts and receives confirmation"
    - "User can text 'OFF' to disarm SMS alerts and receives confirmation"
    - "New project registration sends welcome SMS (when armed)"
    - "Missing tmux session is handled gracefully with SMS notification to user (OPS-05)"
    - "Rate limiter middleware is applied to /api/notify route"
  artifacts:
    - path: "src/routes/notify.ts"
      provides: "Multi-project notification handler with registration, arming, rate limiting, numbered prompts"
      contains: "projectRegistry.register"
    - path: "src/routes/sms.ts"
      provides: "Multi-project SMS routing with ON/OFF commands, numbered response parsing, graceful session handling"
      contains: "parseNumberedResponse"
    - path: "src/index.ts"
      provides: "Updated server mounting with rate limiter"
  key_links:
    - from: "src/routes/notify.ts"
      to: "src/services/project-registry.ts"
      via: "import projectRegistry"
      pattern: "import.*projectRegistry.*from.*project-registry"
    - from: "src/routes/notify.ts"
      to: "src/middleware/rate-limit.ts"
      via: "projectRateLimiter middleware in route chain"
      pattern: "projectRateLimiter"
    - from: "src/routes/sms.ts"
      to: "src/services/project-registry.ts"
      via: "import projectRegistry"
      pattern: "import.*projectRegistry.*from.*project-registry"
    - from: "src/routes/sms.ts"
      to: "src/services/twilio.ts"
      via: "send confirmation SMS for ON/OFF"
      pattern: "twilioService.sendSMS"
    - from: "src/routes/sms.ts"
      to: "src/services/tmux.ts"
      via: "hasSession check before sendKeys"
      pattern: "tmuxService.hasSession"
---

<objective>
Wire the ProjectRegistry and rate limiter into existing routes to enable multi-project SMS routing, ON/OFF arming commands, welcome messages, and graceful session handling.

Purpose: This plan integrates the foundation modules from Plan 01 into the existing notify and SMS routes, transforming the Phase 1 single-project relay into a full multi-project system. After this plan, all Phase 2 requirements (RELAY-07, RELAY-08, RELAY-09, RELAY-10, OPS-01, OPS-05) are satisfied.

Output: Updated notify.ts, sms.ts, and index.ts with multi-project support.
</objective>

<execution_context>
@/Users/tylermeans/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tylermeans/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-multi-project-support/02-RESEARCH.md
@.planning/phases/02-multi-project-support/02-01-SUMMARY.md

Source files to modify:
@src/routes/notify.ts (current Phase 1 implementation)
@src/routes/sms.ts (current Phase 1 implementation)
@src/index.ts (server setup)

Source files to reference:
@src/services/project-registry.ts (created in Plan 01)
@src/middleware/rate-limit.ts (created in Plan 01)
@src/services/twilio.ts (sendSMS for confirmation/welcome)
@src/services/tmux.ts (hasSession for OPS-05)
@src/lib/sanitize.ts (formatForSMS)
@src/types.ts (NotificationPayload - needs project_id field)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update notify.ts for multi-project registration, numbered prompts, and rate limiting</name>
  <files>src/routes/notify.ts, src/types.ts</files>
  <action>
**Step 1: Update NotificationPayload type in `src/types.ts`.**

Add `project_id` and `project_name` as optional fields to the `NotificationPayload` interface. These come from the Claude Code hook payload. Make them optional (`project_id?: string`, `project_name?: string`) so the endpoint remains backward-compatible with Phase 1 payloads that may not include them. Also add `tmux_session?: string` as an optional field for the tmux session name (replaces TMUX_SESSION env var for multi-project).

**Step 2: Rewrite `src/routes/notify.ts` with multi-project support.**

Add imports:
- `projectRegistry` from `../services/project-registry.js`
- `projectRateLimiter` from `../middleware/rate-limit.js`
- `twilioService` from `../services/twilio.js` (already imported)

Update the route definition to include `projectRateLimiter` in the middleware chain:
```
router.post('/api/notify', bearerAuth, projectRateLimiter, async (req, res) => {
```

Inside the async handler, after `res.sendStatus(200)`:

1. **Extract project info from payload.** Get `project_id`, `project_name`, `session_id`, and `tmux_session` from payload. Derive `projectId` as `project_id || session_id` (fallback for backward compatibility). Derive `sessionId` as `tmux_session || session_id || process.env.TMUX_SESSION` (backward-compatible with Phase 1 TMUX_SESSION env var). Derive `projectName` as `project_name || projectId` (use ID as name if name not provided).

2. **Register project.** Call `const isNew = projectRegistry.register(projectId, sessionId, projectName)`.

3. **Check armed state.** If `!projectRegistry.isArmed()`, log `[notify] System disarmed - suppressing notification for ${projectName}` and return early from the async IIFE. Do NOT send notification SMS. But still register the project (so it appears when user arms later).

4. **Send welcome SMS for new projects (RELAY-10).** If `isNew && projectRegistry.isArmed()`, send welcome SMS:
   ```
   Welcome! "${projectName}" registered with Claude SMS Connect.

   Reply with "N Y" where N is the project number.
   Text ON to arm alerts, OFF to disarm.
   ```
   Use `twilioService.sendSMS(process.env.USER_PHONE_NUMBER!, welcomeMessage)`.

5. **Check rate limiting (application-level).** Call `projectRegistry.canNotify(projectId)`. If false, log and return. Note: express-rate-limit handles HTTP-level 429 responses. This is a secondary check for the async processing path (since we already returned 200).

6. **Record notification.** Call `projectRegistry.recordNotification(projectId)`.

7. **Capture terminal context** (same as Phase 1, but use `sessionId` variable instead of `session_id` directly). Wrap in try/catch, fall back to generic message if tmux capture fails.

8. **Format multi-project SMS (RELAY-07).** Check `projectRegistry.getActiveProjects()`. If only 1 project is active, use Phase 1 format: `"Claude Code needs input:\n\n${context}\n\nReply Y/N or text response"`. If multiple projects, use numbered format:
   ```
   [1] project-a
   [2] project-b

   Latest (${projectName}):
   ${context}

   Reply: N RESPONSE (e.g., "1 Y")
   ```
   Use `formatForSMS(context, 200)` for multi-project messages (shorter context to fit in SMS) vs `formatForSMS(context, 450)` for single-project messages.
   Build numbered list with 1-indexed display: `projects.map((p, i) => \`[\${i + 1}] \${p.projectName}\`).join('\n')`.

9. **Send SMS** via `twilioService.sendSMS(recipientPhone, message)`.

Keep the OPS-04 pattern: return 200 immediately, process in async IIFE, catch-all error handler.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no TypeScript errors. Verify notify.ts imports projectRegistry and projectRateLimiter. Verify it calls `projectRegistry.register()`, checks `isArmed()`, sends welcome SMS for new projects, and formats numbered prompts for multiple active projects.
  </verify>
  <done>
notify.ts registers projects on every notification, respects armed state, sends welcome SMS to new projects (when armed), formats numbered prompts for multi-project scenarios, applies rate limiter middleware, and maintains OPS-04 compliance (200 immediately, async processing).
  </done>
</task>

<task type="auto">
  <name>Task 2: Update sms.ts for ON/OFF commands, numbered routing, and graceful session handling</name>
  <files>src/routes/sms.ts, src/index.ts</files>
  <action>
**Step 1: Rewrite `src/routes/sms.ts` with multi-project routing.**

Add imports:
- `projectRegistry` from `../services/project-registry.js`
- `twilioService` from `../services/twilio.js`
- Keep existing `tmuxService` and `twilioAuth` imports

**Add parseNumberedResponse helper function** (can be in the same file or a separate module - keep in same file for simplicity since it's small):

```typescript
interface ParsedResponse {
  projectIndex: number | null;
  response: string;
}

function parseNumberedResponse(smsBody: string): ParsedResponse {
  const match = smsBody.trim().match(/^(\d+)\s+(.+)$/s);
  if (match) {
    const projectIndex = parseInt(match[1], 10) - 1; // 1-indexed user input to 0-indexed
    return { projectIndex, response: match[2].trim() };
  }
  return { projectIndex: null, response: smsBody.trim() };
}
```

Use `/s` flag (dotall) on regex so `.+` matches multiline responses. CRITICAL: Subtract 1 from user's number to convert to 0-indexed (Pitfall 2 from research).

**Rewrite the POST /sms/inbound handler** with this flow:

1. **Extract and validate sender** (same as Phase 1 - check USER_PHONE_NUMBER, reject unauthorized senders). Keep existing pattern.

2. **Parse user input.** Trim messageBody. If empty, send help TwiML response (same as Phase 1).

3. **Handle ON/OFF control commands (RELAY-09).** Check `userInput.toUpperCase()`:
   - If `"ON"`: call `projectRegistry.setArmed(true)`, send confirmation SMS via `twilioService.sendSMS()`: `"SMS notifications ARMED. You will receive alerts when Claude Code needs input."`, return empty TwiML `<Response></Response>`.
   - If `"OFF"`: call `projectRegistry.setArmed(false)`, send confirmation SMS: `"SMS notifications DISARMED. No alerts will be sent until you text ON."`, return empty TwiML.
   - Otherwise: continue to response routing.

4. **Parse numbered response (RELAY-08).** Call `parseNumberedResponse(userInput)` to get `{ projectIndex, response }`.

5. **Route to project.**
   - If `projectIndex !== null` (user sent "1 Y" format):
     - Get project via `projectRegistry.getByIndex(projectIndex)`
     - If project not found: send TwiML error message `"Invalid project number ${projectIndex + 1}. Text a valid number + response."` and return.
     - Otherwise: use project's `sessionId` and `response` for tmux routing.
   - If `projectIndex === null` (user sent plain response like "Y"):
     - Get active projects via `projectRegistry.getActiveProjects()`
     - If exactly 1 project: route to that project (backward compatible with Phase 1)
     - If 0 projects: check `process.env.TMUX_SESSION` as fallback (Phase 1 backward compatibility). If no TMUX_SESSION either, send TwiML error: `"No active projects. Send a notification first."` and return.
     - If 2+ projects: send TwiML message: `"Multiple projects active. Reply with number + response (e.g., '1 Y')."` and return.

6. **Check tmux session exists (OPS-05).** Before sending keys, call `await tmuxService.hasSession(sessionId)`. If session does not exist:
   - Log error: `[sms] Session "${sessionId}" no longer exists`
   - Send SMS notification to user: `"Error: tmux session \"${sessionId}\" not found for project \"${projectName}\". The session may have been closed."`
   - Remove project from registry: `projectRegistry.remove(projectId)` - find the projectId by iterating or matching sessionId.
   - Return empty TwiML.

7. **Send input to tmux.** Call `await tmuxService.sendKeys(sessionId, response)`. Log success. Return empty TwiML `<Response></Response>`.

Keep the existing try/catch error handling pattern that returns a 500 TwiML error response.

**Step 2: No changes needed to `src/index.ts`.**

The rate limiter is applied directly in notify.ts route definition (not as app-level middleware), so index.ts does not need modification. Verify that index.ts already mounts notifyRouter and smsRouter.

However, if index.ts needs updating for any import changes, update it. The existing `app.use(notifyRouter)` and `app.use(smsRouter)` should work as-is since we are modifying the route handlers, not the router structure.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no TypeScript errors. Verify sms.ts handles ON/OFF commands, parses numbered responses, routes to correct project by index, checks tmux session existence before sendKeys, and handles graceful fallback for missing sessions. Verify single-project backward compatibility (plain "Y" routes to sole active project or TMUX_SESSION fallback).
  </verify>
  <done>
sms.ts handles ON/OFF arming commands with confirmation SMS, parses numbered responses (e.g., "1 Y" -> project index 0), routes to correct tmux session, checks session existence before sendKeys (OPS-05), sends error SMS for missing sessions, removes stale projects, and maintains backward compatibility with single-project Phase 1 behavior.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. notify.ts imports and uses projectRegistry.register(), projectRegistry.isArmed(), projectRateLimiter
3. notify.ts sends welcome SMS for new projects when armed (RELAY-10)
4. notify.ts formats numbered prompts for multi-project scenarios (RELAY-07)
5. sms.ts handles "ON" command -> sets armed=true + sends confirmation (RELAY-09)
6. sms.ts handles "OFF" command -> sets armed=false + sends confirmation (RELAY-09)
7. sms.ts parses "1 Y" format -> routes to project index 0 (RELAY-08)
8. sms.ts checks tmuxService.hasSession() before sendKeys (OPS-05)
9. sms.ts sends error SMS and removes project when session missing (OPS-05)
10. Single-project backward compatibility: plain "Y" routes to sole active project
</verification>

<success_criteria>
- All Phase 2 requirements satisfied: RELAY-07, RELAY-08, RELAY-09, RELAY-10, OPS-01, OPS-05
- User receives numbered SMS when multiple projects active
- User reply "N RESPONSE" routes to correct project's tmux session
- ON/OFF commands arm/disarm notifications with confirmation
- Welcome SMS sent on first project registration (when armed)
- Missing tmux sessions handled gracefully (error SMS + cleanup)
- Rate limiter applied to /api/notify
- TypeScript compiles without errors
- Backward compatible with Phase 1 single-project usage
</success_criteria>

<output>
After completion, create `.planning/phases/02-multi-project-support/02-02-SUMMARY.md`
</output>
