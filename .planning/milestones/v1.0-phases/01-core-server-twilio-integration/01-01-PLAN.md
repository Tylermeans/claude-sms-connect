---
phase: 01-core-server-twilio-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - .env.example
  - .gitignore
  - src/index.ts
  - src/middleware/auth.ts
  - src/types.ts
autonomous: true
user_setup:
  - service: local-dev
    why: "Generate secure bearer token for Claude Code hook authentication"
    env_vars:
      - name: AUTH_TOKEN
        source: "Generate with: openssl rand -hex 32"

must_haves:
  truths:
    - "Express server starts on port 3000 without errors"
    - "POST /api/notify with valid bearer token returns 200"
    - "POST /api/notify without bearer token returns 401"
    - "GET /health returns 200 for health checks"
  artifacts:
    - path: "package.json"
      provides: "Dependencies: express, twilio, dotenv, strip-ansi, TypeScript tooling"
      contains: "express"
    - path: "src/index.ts"
      provides: "Express server entrypoint with health route"
      min_lines: 20
    - path: "src/middleware/auth.ts"
      provides: "Bearer token validation middleware"
      exports: ["bearerAuth"]
    - path: "tsconfig.json"
      provides: "TypeScript configuration for Node.js 22 + ES modules"
      contains: "module"
  key_links:
    - from: "src/index.ts"
      to: "src/middleware/auth.ts"
      via: "import statement"
      pattern: "import.*auth"
    - from: ".env.example"
      to: "src/middleware/auth.ts"
      via: "AUTH_TOKEN environment variable"
      pattern: "AUTH_TOKEN"
---

<objective>
Bootstrap Node.js + TypeScript + Express project with secure bearer token authentication middleware ready for Claude Code hooks.

Purpose: Establish project foundation with security built in from day one — all dependencies installed, TypeScript configured, Express server running, and bearer auth middleware protecting /api routes.

Output: Working Express server with health endpoint and auth middleware, ready for hook and SMS route implementation.
</objective>

<execution_context>
@/Users/tylermeans/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tylermeans/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/tylermeans/github/claude-sms-connect/.planning/PROJECT.md
@/Users/tylermeans/github/claude-sms-connect/.planning/ROADMAP.md
@/Users/tylermeans/github/claude-sms-connect/.planning/phases/01-core-server-twilio-integration/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Initialize Node.js project with TypeScript and dependencies</name>
  <files>
package.json
tsconfig.json
.gitignore
.env.example
  </files>
  <action>
Initialize Node.js project and install dependencies from research recommendations:

1. Create package.json with:
   - name: "claude-sms-connect"
   - version: "0.1.0"
   - type: "module" (ES modules for Node.js 22)
   - scripts: "dev": "nodemon --exec tsx src/index.ts", "build": "tsc", "start": "node dist/index.js"
   - engines: "node": ">=22.0.0"

2. Install core dependencies (exact versions from research):
   - express@^4.19.0
   - twilio@^5.11.0
   - dotenv@^16.4.0
   - strip-ansi@^7.1.0

3. Install dev dependencies:
   - typescript@^5.6.0
   - @types/express@^4.17.0
   - @types/node@^22.0.0
   - tsx@^4.7.0
   - nodemon@^3.1.0

4. Create tsconfig.json with:
   - target: "ES2022"
   - module: "ESNext"
   - moduleResolution: "bundler"
   - outDir: "dist"
   - rootDir: "src"
   - strict: true
   - esModuleInterop: true

5. Create .gitignore with: node_modules/, dist/, .env, *.log

6. Create .env.example with placeholders:
   ```
   PORT=3000
   AUTH_TOKEN=generate_with_openssl_rand_hex_32
   TWILIO_ACCOUNT_SID=your_account_sid
   TWILIO_AUTH_TOKEN=your_auth_token
   TWILIO_PHONE_NUMBER=your_twilio_number
   USER_PHONE_NUMBER=your_phone_number
   ```
  </action>
  <verify>
Run `npm install` to verify dependencies install without errors. Check that `node_modules/` exists and contains express, twilio, dotenv, strip-ansi.
  </verify>
  <done>
package.json exists with all dependencies listed, tsconfig.json configured for ES modules, .env.example contains all required environment variables, npm install completes successfully.
  </done>
</task>

<task type="auto">
  <name>Create Express server with bearer auth middleware</name>
  <files>
src/index.ts
src/middleware/auth.ts
src/types.ts
  </files>
  <action>
Create Express server entrypoint with bearer token authentication middleware:

1. Create src/types.ts with TypeScript interfaces:
   - NotificationPayload interface matching Claude Code hook schema from research (session_id, message, notification_type, etc.)
   - Environment variables interface (PORT, AUTH_TOKEN, TWILIO_*)

2. Create src/middleware/auth.ts:
   - Export bearerAuth middleware function
   - Extract Authorization header
   - Validate format: "Bearer <token>"
   - Compare token against process.env.AUTH_TOKEN (constant-time comparison)
   - Return 401 if missing/invalid, call next() if valid
   - Log auth failures for debugging

3. Create src/index.ts:
   - Import dotenv/config at top
   - Create Express app
   - Add express.json() middleware for JSON body parsing
   - Add express.urlencoded({ extended: true }) for Twilio webhook bodies
   - Create GET /health route (no auth required) returning { status: 'ok' }
   - Create POST /api/notify route with bearerAuth middleware (returns 200 immediately per OPS-04, no processing yet)
   - Listen on process.env.PORT || 3000
   - Log server start with port number

Security requirements from research:
- Use constant-time string comparison for token validation (crypto.timingSafeEqual)
- Never log the AUTH_TOKEN value
- Return generic 401 responses (don't reveal whether token format or value was wrong)
  </action>
  <verify>
1. Create .env file with AUTH_TOKEN=test_token_12345
2. Run `npm run dev`
3. Verify server starts without errors
4. Test health endpoint: `curl http://localhost:3000/health` returns {"status":"ok"}
5. Test auth success: `curl -X POST http://localhost:3000/api/notify -H "Authorization: Bearer test_token_12345" -H "Content-Type: application/json" -d '{}'` returns 200
6. Test auth failure: `curl -X POST http://localhost:3000/api/notify` returns 401
  </verify>
  <done>
Express server runs on port 3000, GET /health returns 200, POST /api/notify requires valid bearer token (returns 401 without token, 200 with valid token), bearer auth middleware uses constant-time comparison.
  </done>
</task>

</tasks>

<verification>
1. Run `npm install` — all dependencies install without errors
2. Run `npm run dev` — server starts without TypeScript errors
3. GET /health returns 200 with {"status":"ok"}
4. POST /api/notify without Authorization header returns 401
5. POST /api/notify with valid bearer token returns 200
6. All files listed in files_modified exist and contain expected exports
</verification>

<success_criteria>
- Express server starts successfully on port 3000
- Health endpoint responds without authentication
- Bearer auth middleware protects /api routes
- TypeScript compiles without errors
- All core dependencies installed and functional
- .env.example documents all required environment variables
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-server-twilio-integration/01-01-SUMMARY.md`
</output>
