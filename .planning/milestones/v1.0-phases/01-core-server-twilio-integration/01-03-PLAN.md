---
phase: 01-core-server-twilio-integration
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - src/services/twilio.ts
  - src/middleware/twilio-auth.ts
  - src/routes/notify.ts
  - src/routes/sms.ts
  - src/index.ts
autonomous: true
user_setup:
  - service: twilio
    why: "SMS sending and receiving via Twilio Programmable SMS"
    env_vars:
      - name: TWILIO_ACCOUNT_SID
        source: "Twilio Console -> Account Info (starts with AC...)"
      - name: TWILIO_AUTH_TOKEN
        source: "Twilio Console -> Account Info -> Auth Token"
      - name: TWILIO_PHONE_NUMBER
        source: "Twilio Console -> Phone Numbers -> Active Numbers (format: +1234567890)"
      - name: USER_PHONE_NUMBER
        source: "Your personal phone number (format: +1234567890)"
    dashboard_config:
      - task: "Purchase a phone number with SMS capability"
        location: "Twilio Console -> Phone Numbers -> Buy a Number"
      - task: "Configure webhook URL for incoming messages"
        location: "Twilio Console -> Phone Numbers -> Active Numbers -> Configure -> Messaging -> Webhook URL"
        note: "Set to http://your-ngrok-url/sms/inbound (will be provided after server starts with ngrok)"

must_haves:
  truths:
    - "Server receives Claude Code hook payload and sends SMS via Twilio"
    - "SMS includes project context from last 5-8 lines of terminal output"
    - "User can reply to SMS and response is routed to correct tmux session"
    - "Inbound SMS webhook validates Twilio signature (rejects forged requests)"
    - "Hook handler returns 200 immediately and processes notification async"
  artifacts:
    - path: "src/services/twilio.ts"
      provides: "Twilio SMS sending and message formatting"
      exports: ["TwilioService"]
      min_lines: 30
    - path: "src/middleware/twilio-auth.ts"
      provides: "Twilio webhook signature validation middleware"
      exports: ["twilioAuth"]
    - path: "src/routes/notify.ts"
      provides: "POST /api/notify handler for Claude Code hooks"
      min_lines: 20
    - path: "src/routes/sms.ts"
      provides: "POST /sms/inbound handler for Twilio webhooks"
      min_lines: 30
  key_links:
    - from: "src/routes/notify.ts"
      to: "src/services/tmux.ts"
      via: "captureContext call"
      pattern: "tmuxService\\.captureContext"
    - from: "src/routes/notify.ts"
      to: "src/services/twilio.ts"
      via: "sendSMS call"
      pattern: "twilioService\\.sendSMS"
    - from: "src/routes/sms.ts"
      to: "src/services/tmux.ts"
      via: "sendKeys call"
      pattern: "tmuxService\\.sendKeys"
    - from: "src/routes/sms.ts"
      to: "src/middleware/twilio-auth.ts"
      via: "twilioAuth middleware"
      pattern: "twilioAuth"
---

<objective>
Integrate Twilio SMS and connect all components into working end-to-end flow: Claude Code hook → capture terminal → send SMS → receive reply → send to tmux session.

Purpose: Complete Phase 1 by connecting Express routes to tmux and Twilio services, implementing webhook signature validation, and enabling bidirectional SMS communication with running Claude Code sessions.

Output: Working relay server that receives Claude Code hooks, sends SMS notifications via Twilio, validates inbound SMS webhooks, and routes text replies back to correct tmux sessions.
</objective>

<execution_context>
@/Users/tylermeans/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tylermeans/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/tylermeans/github/claude-sms-connect/.planning/PROJECT.md
@/Users/tylermeans/github/claude-sms-connect/.planning/ROADMAP.md
@/Users/tylermeans/github/claude-sms-connect/.planning/phases/01-core-server-twilio-integration/01-RESEARCH.md

# Dependencies on prior plans
@.planning/phases/01-core-server-twilio-integration/01-01-SUMMARY.md
@.planning/phases/01-core-server-twilio-integration/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Create Twilio service and signature validation middleware</name>
  <files>
src/services/twilio.ts
src/middleware/twilio-auth.ts
  </files>
  <action>
Implement Twilio SMS sending and webhook security following research patterns:

1. Create src/services/twilio.ts:
   - Import twilio package
   - Initialize Twilio client with credentials from env vars:
     `const client = twilio(process.env.TWILIO_ACCOUNT_SID, process.env.TWILIO_AUTH_TOKEN)`
   - Export TwilioService class with method:

     async sendSMS(to: string, body: string): Promise<void>
       - Validate environment variables exist (throw if missing)
       - Call client.messages.create with:
         * to: recipient phone number (from parameter)
         * from: process.env.TWILIO_PHONE_NUMBER
         * body: message text
       - Handle errors gracefully (log but don't throw — notification failures shouldn't crash server)
       - Set reasonable timeout (5 seconds) per research recommendation

   - Export singleton: `export const twilioService = new TwilioService()`

2. Create src/middleware/twilio-auth.ts:
   - Import twilio package
   - Export twilioAuth middleware function
   - Extract X-Twilio-Signature header from request
   - Reconstruct full URL (must match exactly for validation):
     `const url = ${req.protocol}://${req.get('host')}${req.originalUrl}`
   - Call twilio.validateRequest(authToken, signature, url, req.body)
   - Return 403 if validation fails (with warning log)
   - Call next() if valid
   - Handle missing auth token gracefully (return 500)

CRITICAL: Twilio signature validation MUST be on ALL /sms routes from day one (SEC-02). Without this, anyone with webhook URL can forge SMS commands.

3. Add JSDoc comments explaining:
   - Why signature validation is critical (prevents command injection via fake SMS)
   - URL reconstruction requirements (protocol, host, originalUrl must match)
   - Research reference: Twilio security best practices
  </action>
  <verify>
Test Twilio service configuration (requires valid Twilio credentials in .env):

1. Test SMS sending:
   - Create test script or use tsx REPL
   - Call twilioService.sendSMS(process.env.USER_PHONE_NUMBER, 'Test message from claude-sms-connect')
   - Verify SMS received on phone

2. Test signature validation (requires ngrok or similar tunnel):
   - Will be tested in integration with routes task
   - Manual curl with fake signature should return 403
  </verify>
  <done>
TwilioService can send SMS via Twilio API, twilioAuth middleware validates X-Twilio-Signature header using twilio.validateRequest, environment variables are validated before use, errors are handled gracefully.
  </done>
</task>

<task type="auto">
  <name>Create notification and SMS webhook routes</name>
  <files>
src/routes/notify.ts
src/routes/sms.ts
src/index.ts
  </files>
  <action>
Implement end-to-end flow connecting all components:

1. Create src/routes/notify.ts (Claude Code hook handler):
   - Import Express Router, tmuxService, twilioService, formatForSMS, bearerAuth
   - Create router
   - Define POST /api/notify with bearerAuth middleware:

     a) Return 200 IMMEDIATELY (OPS-04: don't block Claude Code)
     b) Process notification asynchronously in IIFE:
        - Extract session_id from req.body (NotificationPayload type)
        - Capture terminal context: await tmuxService.captureContext(session_id, 8)
        - Format for SMS: formatForSMS(context, 450)
        - Build message: `Claude Code needs input:\n\n${formatted}\n\nReply Y/N or text response`
        - Send SMS: await twilioService.sendSMS(process.env.USER_PHONE_NUMBER, message)
        - Wrap in try/catch (log errors, never throw)

   - Export router

2. Create src/routes/sms.ts (Twilio webhook handler):
   - Import Express Router, tmuxService, twilioAuth
   - Create router
   - Define POST /sms/inbound with twilioAuth middleware:

     a) Extract Body and From from req.body (Twilio webhook payload)
     b) Validate From matches USER_PHONE_NUMBER (ignore SMS from unknown numbers)
     c) Parse user response:
        - Trim whitespace
        - If empty, return TwiML response with help text
     d) Get session ID from somewhere (Phase 1: use environment variable or hardcoded for single-project)
        - For Phase 1, accept TMUX_SESSION env var as fallback
        - Log warning if session mapping not implemented
     e) Send user input to tmux:
        - await tmuxService.sendKeys(sessionId, userInput)
     f) Return TwiML response (empty Response for now):
        - res.type('text/xml').send('<Response></Response>')
     g) Wrap in try/catch (return 500 TwiML on error)

   - Export router

3. Update src/index.ts:
   - Import notify and sms routers
   - Mount routes:
     * app.use(notifyRouter)
     * app.use(smsRouter)
   - Add error handling middleware (catch-all)
   - Update server start log with instructions:
     "Server running on port 3000. Set up ngrok tunnel for Twilio webhook."

CRITICAL REQUIREMENTS:
- /api/notify MUST return 200 immediately (OPS-04)
- /sms/inbound MUST validate Twilio signature (SEC-02)
- User input MUST go through tmuxService.sendKeys with -l flag (SEC-05)
- Errors MUST NOT crash the server (wrap all async ops in try/catch)

Phase 1 limitation: Single project support only. Session mapping hardcoded or from env var. Multi-project support deferred to Phase 2.
  </action>
  <verify>
Integration testing (requires Twilio credentials and ngrok tunnel):

1. Start server: `npm run dev`
2. Start ngrok tunnel: `ngrok http 3000`
3. Configure Twilio webhook URL in Twilio Console to ngrok URL + /sms/inbound
4. Start test tmux session: `tmux new -d -s test-relay`
5. Set TMUX_SESSION=test-relay in .env
6. Simulate Claude Code hook:
   ```bash
   curl -X POST http://localhost:3000/api/notify \
     -H "Authorization: Bearer $AUTH_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"session_id":"test-relay","message":"Test notification"}'
   ```
7. Verify:
   - Curl returns 200 immediately
   - SMS received on phone with terminal context
8. Reply to SMS with "Y"
9. Verify:
   - tmux session received "Y" + Enter: `tmux capture-pane -t test-relay -p`
10. Test signature validation:
    ```bash
    curl -X POST http://localhost:3000/sms/inbound \
      -d "Body=test&From=+1234567890"
    # Should return 403 (no valid signature)
    ```
11. Clean up: `tmux kill-session -t test-relay`
  </verify>
  <done>
POST /api/notify receives Claude Code hooks, captures terminal context, sends SMS via Twilio, and returns 200 immediately. POST /sms/inbound receives Twilio webhooks, validates signature, sends user response to tmux session, and returns TwiML. End-to-end flow works: hook → SMS → reply → tmux.
  </done>
</task>

</tasks>

<verification>
Complete end-to-end flow verification:

1. Server starts without errors
2. Claude Code hook triggers SMS notification
3. SMS includes terminal context from tmux session
4. User replies to SMS
5. Reply is validated (Twilio signature) and routed to correct tmux session
6. tmux session receives user input literally (no command injection)
7. Invalid SMS signatures are rejected with 403
8. Hook handler returns 200 in < 100ms (async processing)
</verification>

<success_criteria>
Phase 1 complete when:
- User receives SMS when Claude Code hook fires
- SMS includes last 5-8 lines of terminal context (ANSI-stripped)
- User can reply with Y/N or freeform text
- Reply is piped to correct tmux session verbatim
- All /api routes require valid bearer token
- All /sms routes validate Twilio signature
- No command injection vulnerabilities (tested with shell metacharacters)
- Hook handler responds immediately (< 100ms)
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-server-twilio-integration/01-03-SUMMARY.md`

Also create hooks/claude-relay-hook.json with ready-to-use Claude Code hook configuration template.
</output>
