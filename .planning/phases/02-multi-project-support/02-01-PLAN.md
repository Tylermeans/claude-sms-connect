---
phase: 02-multi-project-support
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/project-registry.ts
  - src/middleware/rate-limit.ts
  - package.json
  - package-lock.json
autonomous: true

must_haves:
  truths:
    - "ProjectRegistry tracks multiple projects in memory with unique IDs"
    - "ProjectRegistry starts disarmed (armed=false) per RELAY-09"
    - "ProjectRegistry supports arming/disarming via setArmed/isArmed"
    - "ProjectRegistry.register() returns true on first registration for welcome SMS trigger"
    - "Rate limiter enforces max 1 notification per 5 seconds per project ID"
  artifacts:
    - path: "src/services/project-registry.ts"
      provides: "Multi-project state management singleton"
      exports: ["ProjectRegistry", "projectRegistry"]
      contains: "armed = false"
    - path: "src/middleware/rate-limit.ts"
      provides: "Per-project rate limiting middleware"
      exports: ["projectRateLimiter"]
      contains: "keyGenerator"
    - path: "package.json"
      provides: "express-rate-limit dependency"
      contains: "express-rate-limit"
  key_links:
    - from: "src/middleware/rate-limit.ts"
      to: "express-rate-limit"
      via: "import rateLimit"
      pattern: "import.*from.*express-rate-limit"
    - from: "src/services/project-registry.ts"
      to: "Map"
      via: "private projects field"
      pattern: "new Map"
---

<objective>
Create the ProjectRegistry service and per-project rate limiter middleware that form the foundation for multi-project support.

Purpose: Phase 2 requires tracking multiple simultaneous Claude Code projects, enforcing per-project rate limits, and providing arming controls. These two new modules are pure additions (no existing files modified) that later plans will wire into the existing routes.

Output: Two new modules (project-registry.ts, rate-limit.ts) and express-rate-limit dependency installed.
</objective>

<execution_context>
@/Users/tylermeans/.claude/get-shit-done/workflows/execute-plan.md
@/Users/tylermeans/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-multi-project-support/02-RESEARCH.md
@.planning/phases/01-core-server-twilio-integration/01-02-SUMMARY.md
@.planning/phases/01-core-server-twilio-integration/01-03-SUMMARY.md

Source files to reference for patterns:
@src/services/tmux.ts (singleton service pattern to follow)
@src/services/twilio.ts (singleton service pattern to follow)
@src/middleware/auth.ts (middleware pattern to follow)
@src/types.ts (type definitions)
@package.json (current dependencies)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProjectRegistry service for multi-project state management</name>
  <files>src/services/project-registry.ts</files>
  <action>
Create `src/services/project-registry.ts` following the singleton pattern from tmux.ts and twilio.ts.

**ProjectMetadata interface:**
- `sessionId: string` - tmux session identifier for routing responses
- `projectName: string` - human-readable name for SMS display
- `lastNotified: number` - timestamp for rate limiting (initialize to 0 for new projects)
- `registeredAt: number` - timestamp for tracking registration time

**ProjectRegistry class with these methods:**
- `register(projectId: string, sessionId: string, projectName: string): boolean` - Add/update project in Map. Return `true` if this is the first time this projectId is registered (triggers welcome SMS per RELAY-10). If updating an existing project, preserve `lastNotified` and `registeredAt` from previous entry.
- `getActiveProjects(): ProjectMetadata[]` - Return all projects as array (Map preserves insertion order per ES2015 spec). Used for numbered SMS display.
- `getByIndex(index: number): ProjectMetadata | undefined` - Get project by 0-indexed position. Used for routing numbered responses ("1 Y" -> index 0).
- `get(projectId: string): ProjectMetadata | undefined` - Get project by ID.
- `canNotify(projectId: string): boolean` - Returns false if `armed === false`. Returns true if project has never been notified (`lastNotified === 0`). Otherwise checks if 5+ seconds have elapsed since `lastNotified` (OPS-01).
- `recordNotification(projectId: string): void` - Set project's `lastNotified` to `Date.now()`.
- `setArmed(armed: boolean): void` - Set global armed state. Log state change.
- `isArmed(): boolean` - Return current armed state.
- `remove(projectId: string): boolean` - Delete project from Map (for cleanup when tmux session missing per OPS-05).
- `count(): number` - Return `this.projects.size`.

**CRITICAL: `armed` must initialize to `false`** per RELAY-09 requirement (OFF by default).

Export both the class (`ProjectRegistry`) and a singleton instance (`projectRegistry`).

Follow these conventions from existing services:
- JSDoc comments on class and all public methods
- Console.log for state changes with `[ProjectRegistry]` prefix
- Class + singleton export pattern matching tmux.ts and twilio.ts
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no TypeScript errors. Verify the file exists and contains: `armed = false`, `new Map`, both named exports (ProjectRegistry class and projectRegistry instance).
  </verify>
  <done>
ProjectRegistry service exists at src/services/project-registry.ts with all methods, starts disarmed (armed=false), tracks projects via Map, register() returns boolean for welcome SMS trigger, canNotify() respects both arming and 5-second rate limit.
  </done>
</task>

<task type="auto">
  <name>Task 2: Install express-rate-limit and create per-project rate limiter middleware</name>
  <files>src/middleware/rate-limit.ts, package.json, package-lock.json</files>
  <action>
**Step 1: Install dependency.**
Run `npm install express-rate-limit@^8.2.1` to add the rate limiting package.

**Step 2: Create `src/middleware/rate-limit.ts`.**

Follow the middleware pattern from `src/middleware/auth.ts`.

Import `rateLimit` from `express-rate-limit`. Import `Request` type from `express`.

Create and export `projectRateLimiter` using `rateLimit()` with this configuration:
- `windowMs: 5000` (5 second window per OPS-01)
- `max: 1` (1 request per window per project)
- `standardHeaders: true` (include RateLimit-* headers in response)
- `legacyHeaders: false` (disable X-RateLimit-* headers)
- `keyGenerator: (req: Request): string =>` extract `project_id` from `req.body`. If `project_id` is missing/falsy, fall back to `req.ip || 'unknown'` and log a warning with `[rate-limit]` prefix. **CRITICAL: Must use project_id, NOT IP address** (Pitfall 1 from research - all projects run on same machine with same IP).
- `handler: (req, res)` - Log warning with project_id, return 429 with JSON body `{ error: 'Too many notifications', message: 'Rate limit: max 1 notification per 5 seconds per project', project_id }`.

Add JSDoc comment on the export explaining OPS-01 requirement and why keyGenerator uses project_id instead of IP.
  </action>
  <verify>
Run `npm ls express-rate-limit` to confirm package installed. Run `npx tsc --noEmit` to confirm no TypeScript errors. Verify rate-limit.ts contains `keyGenerator` function extracting `project_id` from `req.body`.
  </verify>
  <done>
express-rate-limit installed in package.json, rate-limit.ts middleware exists with per-project keyGenerator using project_id from request body (not IP), 5-second window, max 1 request per project, returns 429 on limit exceeded.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm ls express-rate-limit` shows express-rate-limit@8.x installed
3. src/services/project-registry.ts exists with ProjectRegistry class and projectRegistry singleton
4. src/middleware/rate-limit.ts exists with projectRateLimiter export
5. ProjectRegistry starts with armed=false (grep confirms `armed = false`)
6. Rate limiter uses project_id keyGenerator (grep confirms `req.body` in keyGenerator)
</verification>

<success_criteria>
- ProjectRegistry singleton tracks projects via Map with register/get/getByIndex/canNotify/setArmed methods
- ProjectRegistry defaults to disarmed (armed=false)
- register() returns boolean indicating first-time registration
- canNotify() respects both armed state and 5-second rate limit
- Rate limiter middleware limits /api/notify to 1 request per 5 seconds per project_id
- TypeScript compiles without errors
- No existing files modified (pure additions)
</success_criteria>

<output>
After completion, create `.planning/phases/02-multi-project-support/02-01-SUMMARY.md`
</output>
