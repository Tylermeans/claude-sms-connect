# Claude SMS Connect

Respond to Claude Code prompts from your phone via Telegram. When Claude Code needs input — a Y/N approval, a file path, a design decision — it messages you on Telegram. You reply, and your response gets piped straight into the terminal.

No app to install. No webhook setup. Just a Telegram bot.

```
┌──────────────────┐   HTTP POST    ┌──────────────────┐  Telegram API  ┌──────────────────┐
│   Claude Code    │ ────────────► │   Relay Server   │ ──────────────► │    Telegram      │
│  (runs in tmux)  │               │  (Node/Express)  │                 │   (your phone)   │
│                  │ tmux send-keys │                  │ ◄────────────── │                  │
│                  │ ◄──────────── │  long-polling     │  Bot messages   │                  │
└──────────────────┘               └──────────────────┘                 └──────────────────┘
```

## Prerequisites

- **Node.js 22+** — `node -v` to check
- **tmux** — `brew install tmux` on macOS
- **Telegram account** — free, any phone

## Quick Start

### 1. Clone and set up

```bash
git clone <your-repo-url> claude-sms-connect
cd claude-sms-connect
npm run setup
```

The setup script will:
- Generate a cryptographically secure auth token
- Create your `.env` file from the template
- Install dependencies
- Print next steps

### 2. Create a Telegram bot

1. Open Telegram and message [@BotFather](https://t.me/BotFather)
2. Send `/newbot` and follow the prompts
3. Copy the bot token (looks like `123456789:ABCdefGHIjklMNOpqrSTUvwxYZ`)

### 3. Get your Telegram chat ID

1. Message [@userinfobot](https://t.me/userinfobot) on Telegram
2. Copy your numeric chat ID (e.g., `123456789`)

### 4. Configure .env

Edit `.env` and fill in your Telegram details:

```bash
AUTH_TOKEN=<already generated by setup>

# From @BotFather
TELEGRAM_BOT_TOKEN=123456789:ABCdefGHIjklMNOpqrSTUvwxYZ

# From @userinfobot
TELEGRAM_CHAT_ID=123456789
```

### 5. Start the server

```bash
npm run dev
```

You should see:

```
Claude SMS Connect server listening on port 3000
Health check: http://localhost:3000/health
Notification endpoint: http://localhost:3000/api/notify

Telegram polling active — send ON to your bot to arm notifications.
```

### 6. Configure the Claude Code hook

Claude Code needs to know to call your relay server when it needs input. There are two ways to set this up:

**Option A: Use the included hook script**

```bash
# Copy the hook script
cp hooks/claude-code-hook.sh ~/.claude/hooks/
chmod +x ~/.claude/hooks/claude-code-hook.sh

# Edit the AUTH_TOKEN to match your .env
nano ~/.claude/hooks/claude-code-hook.sh
```

Then add to `~/.claude/settings.json`:

```json
{
  "hooks": {
    "Notification": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "~/.claude/hooks/claude-code-hook.sh",
            "timeout": 5
          }
        ]
      }
    ]
  }
}
```

**Option B: Inline curl command**

Add directly to `~/.claude/settings.json` (replace `YOUR_AUTH_TOKEN`):

```json
{
  "hooks": {
    "Notification": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "curl -s -X POST http://localhost:3000/api/notify -H 'Authorization: Bearer YOUR_AUTH_TOKEN' -H 'Content-Type: application/json' -d '{\"session_id\": \"'\"$CLAUDE_SESSION_ID\"'\", \"project_id\": \"'\"$(basename $CLAUDE_PROJECT_DIR)\"'\", \"project_name\": \"'\"$(basename $CLAUDE_PROJECT_DIR)\"'\", \"tmux_session\": \"'\"$CLAUDE_SESSION_ID\"'\"}' --max-time 5 > /dev/null 2>&1 || true",
            "timeout": 5
          }
        ]
      }
    ]
  }
}
```

### 7. Run Claude Code inside tmux

Claude SMS Connect uses tmux to capture terminal context and pipe responses back. Your Claude Code session must be running inside a tmux session.

**Option A: Auto-wrap with shell function (recommended)**

Add this to your `~/.zshrc` (or `~/.bashrc`):

```bash
claude() {
  if [ -n "$TMUX" ]; then
    unset CLAUDECODE
    command claude "$@"
    return
  fi
  local session="$(basename "$PWD")"
  if tmux has-session -t "$session" 2>/dev/null; then
    tmux attach-session -t "$session"
  else
    tmux new-session -s "$session" "unset CLAUDECODE; command claude $*; exec $SHELL"
  fi
}
```

Then `source ~/.zshrc` and just type `claude` from any project directory. It automatically creates a tmux session named after your project folder — no manual tmux management needed.

**Option B: Manual tmux**

```bash
# Create a named tmux session
tmux new-session -s my-project

# Inside tmux, run Claude Code
claude
```

### 8. Arm the system

Send **ON** to your Telegram bot. You'll get a confirmation:

```
Notifications ARMED. You will receive alerts when Claude Code needs input.
```

Now walk away. When Claude Code needs input, you'll get a Telegram message.

## Usage

### Replying to prompts

**Single project running:**

```
Claude Code needs input:

Allow file write to src/index.ts?
> ...terminal context...

Reply Y/N or text response
```

Reply with just your answer:
- `Y` — approve
- `N` — deny
- `use the auth middleware instead` — freeform response

**Multiple projects running:**

```
[1] my-api
[2] my-frontend

Latest (my-api):
Allow npm install express?

Reply: N RESPONSE (e.g., "1 Y")
```

Reply with the project number + your answer:
- `1 Y` — approve for my-api
- `2 N` — deny for my-frontend
- `1 use redis instead` — freeform to my-api

### Control commands

| Command | Effect |
|---------|--------|
| `ON`    | Arm notifications — start receiving Telegram alerts |
| `OFF`   | Disarm notifications — silence all alerts |

Notifications are **off by default**. You must send ON to start receiving them.

## How It Works

1. **Claude Code hook fires** — when Claude Code needs input, it calls your hook script
2. **Hook sends POST to relay server** — `POST /api/notify` with project info and bearer token auth
3. **Server returns 200 immediately** — never blocks Claude Code (processes async)
4. **Server captures tmux context** — grabs last 8 lines of terminal output via `tmux capture-pane`
5. **Server redacts sensitive data** — strips API keys, tokens, passwords (13 patterns) before sending
6. **Server sends message via Telegram Bot API** — formatted with project context and reply instructions
7. **Server polls for your reply** — long-polling Telegram Bot API for new messages
8. **Server validates chat ID** — confirms the message is from your authorized Telegram account
9. **Server parses your reply** — handles numbered responses, Y/N, freeform text
10. **Server pipes response to tmux** — `tmux send-keys -l` (literal mode, prevents injection) + Enter

## Security

- **Bearer token auth** on all `/api` routes — timing-safe comparison via `crypto.timingSafeEqual`
- **Telegram chat ID validation** — only messages from your configured chat ID are accepted
- **Sensitive data redaction** — AWS keys, GitHub tokens, OpenAI keys, JWTs, passwords, private key blocks are all redacted before sending
- **Shell injection prevention** — all tmux commands use `execFile` with args arrays (never `exec` with string interpolation)
- **Literal send-keys** — `-l` flag prevents tmux from interpreting user input as key bindings

## Project Structure

```
src/
├── index.ts                    # Express server entry point
├── types.ts                    # TypeScript type definitions
├── lib/
│   ├── redact.ts               # Sensitive data redaction (13 patterns)
│   ├── redact.test.ts          # 34 redaction tests
│   └── sanitize.ts             # Message formatting pipeline (ANSI strip → redact → truncate)
├── middleware/
│   ├── auth.ts                 # Bearer token authentication
│   └── rate-limit.ts           # Per-project rate limiting (1 per 5s)
├── routes/
│   └── notify.ts               # POST /api/notify — hook receiver
└── services/
    ├── telegram.ts             # Telegram Bot API client
    ├── telegram-poller.ts      # Long-polling message handler
    ├── project-registry.ts     # Multi-project state tracking
    └── tmux.ts                 # tmux capture/send-keys (injection-safe)
scripts/
└── setup.js                    # One-command setup automation
hooks/
└── claude-code-hook.sh         # Ready-to-use Claude Code hook script
```

## Troubleshooting

**"System disarmed" in server logs, no messages received**
Send `ON` to your Telegram bot. Notifications are off by default.

**"Telegram bot token not configured"**
Check your `.env` has `TELEGRAM_BOT_TOKEN` set with the token from @BotFather.

**"TELEGRAM_CHAT_ID not configured"**
Check your `.env` has `TELEGRAM_CHAT_ID` set with your numeric ID from @userinfobot.

**"No tmux session identifier found"**
Make sure Claude Code is running inside a tmux session, and the hook script includes `tmux_session` in the payload.

**"Invalid project number"**
You sent a numbered reply but the project index was wrong. The numbers correspond to the order projects registered. If projects have restarted, numbers may have changed.

**Messages not arriving**
1. Check server logs — is the notification reaching the server?
2. Make sure you messaged your bot at least once (Telegram requires this before a bot can message you)
3. Verify TELEGRAM_BOT_TOKEN and TELEGRAM_CHAT_ID are correct in `.env`

**Reply not reaching Claude Code**
1. Confirm tmux session is still running: `tmux list-sessions`
2. Check server logs for routing messages
3. Verify the session name in the hook payload matches the tmux session

**Rate limited**
Notifications are throttled to 1 per 5 seconds per project. If Claude Code fires hooks rapidly, some will be silently dropped.

## API Reference

| Endpoint | Method | Auth | Purpose |
|----------|--------|------|---------|
| `/health` | GET | None | Health check |
| `/api/notify` | POST | Bearer token | Receive Claude Code hook notifications |

## License

ISC
